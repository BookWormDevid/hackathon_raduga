import os
import json
import shutil
from PIL import Image
from tqdm import tqdm

PATCH_SIZE = 640
INPUT_IMAGE_DIR = "images"
ANNOTATIONS_FILE = "annotations.json"
OUTPUT_DIR = "patch_dataset"
CLASS_NAMES = ["person"]

for subdir in ["images", "labels"]:
    os.makedirs(f"{OUTPUT_DIR}/{subdir}", exist_ok=True)

def convert_bbox(bbox, img_w, img_h):
    x_min, y_min, x_max, y_max = bbox
    x_center = (x_min + x_max) / 2.0 / img_w
    y_center = (y_min + y_max) / 2.0 / img_h
    width = (x_max - x_min) / img_w
    height = (y_max - y_min) / img_h
    return x_center, y_center, width, height

def bbox_inside_patch(bbox, px, py, patch_size):
    x_min, y_min, x_max, y_max = bbox
    return not (x_max <= px or x_min >= px + patch_size or y_max <= py or y_min >= py + patch_size)

def adjust_bbox_to_patch(bbox, px, py):
    x_min, y_min, x_max, y_max = bbox
    return [x_min - px, y_min - py, x_max - px, y_max - py]

with open(ANNOTATIONS_FILE) as f:
    annotations = json.load(f)

img_id = 0

for ann in tqdm(annotations, desc="Обработка изображений"):
    img_path = os.path.join(INPUT_IMAGE_DIR, ann["filename"])
    if not os.path.exists(img_path):
        continue

    img = Image.open(img_path)
    img_w, img_h = img.size
    objects = ann["objects"]

    for py in range(0, img_h, PATCH_SIZE):
        for px in range(0, img_w, PATCH_SIZE):
            patch = img.crop((px, py, px + PATCH_SIZE, py + PATCH_SIZE))
            patch_w, patch_h = patch.size

            patch_objects = []
            for obj in objects:
                bbox = obj["bbox"]
                if bbox_inside_patch(bbox, px, py, PATCH_SIZE):
                    adj_bbox = adjust_bbox_to_patch(bbox, px, py)

                    adj_bbox = [
                        max(0, min(PATCH_SIZE, adj_bbox[0])),
                        max(0, min(PATCH_SIZE, adj_bbox[1])),
                        max(0, min(PATCH_SIZE, adj_bbox[2])),
                        max(0, min(PATCH_SIZE, adj_bbox[3])),
                    ]

                    patch_objects.append((obj["class_id"], adj_bbox))

            if not patch_objects:
                continue

            patch_filename = f"{img_id:06d}.jpg"
            label_filename = f"{img_id:06d}.txt"

            patch.save(os.path.join(OUTPUT_DIR, "images", patch_filename))

            with open(os.path.join(OUTPUT_DIR, "labels", label_filename), "w") as f:
                for class_id, bbox in patch_objects:
                    x, y, bw, bh = convert_bbox(bbox, patch_w, patch_h)
                    f.write(f"{class_id} {x:.6f} {y:.6f} {bw:.6f} {bh:.6f}\n")

            img_id += 1
